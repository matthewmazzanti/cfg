#!/usr/bin/env bash

function update_flake() {
    pushd "$1" >/dev/null
    nix flake update --allow-dirty
    if ! git diff --exit-code flake.lock >/dev/null; then
        git add flake.lock
    fi
    popd >/dev/null
}

pushd $ROOT >/dev/null

git update-index --refresh >/dev/null
if ! git diff-index --quiet HEAD --; then
    git status
    exit 1
fi

update_flake "$ROOT/pkgs/direnv"
update_flake "$ROOT/pkgs/nvim"
update_flake "$ROOT/pkgs/short-pwd"
update_flake "$ROOT/pkgs/tmux"
update_flake "$ROOT/pkgs/zsh"

if ! git diff --exit-code --staged >/dev/null; then
    git commit -m "Update pkgs/*/flake.lock"
fi

nix flake update --commit-lock-file
popd >/dev/null
